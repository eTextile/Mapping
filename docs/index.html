<!DOCTYPE html>

<html>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>e256_mapping</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  </head>

  <body>
    <div id="e256_controls">
      <button id="connectButton">E256_CONNECT</button><span id="connectStatus">E256_DISCONNECTED</span><br/>
      <input type="file" id="loadConfigButton" accept=".json"><br/>
      <button id="sendConfigButton">SEND_CONFIG</button><br/>
      <textarea readonly id="receiveText" ></textarea>
    </div>
  
    <script type="text/javascript">
      //var val1 = 0;
      //var val2 = 0;
      
      var configFile = "";

      // Define the elements
      let connectButton = document.getElementById("connectButton");
      let connectStatus = document.getElementById("connectStatus");
      let loadConfigButton = document.getElementById("loadConfigButton");
      let sendConfigButton = document.getElementById("sendConfigButton");
      let receiveText = document.getElementById("receiveText");
      
      // Couple the elements to the Events
      connectButton.addEventListener('click', MIDIConnect);
      loadConfigButton.addEventListener('change', loadConfig);
      sendConfigButton.addEventListener('click', sendConfig);
      
      var midi, data;

      async function MIDIConnect() {
        // request MIDI access
        if (navigator.requestMIDIAccess) {
          navigator.requestMIDIAccess({sysex: true}).then(onMIDISuccess, onMIDIFailure);
        } else {
          alert("No MIDI support in your browser.");
        }
      }

      function onMIDISuccess(midiAccess) {
        // when we get a succesful response, run this code
        var inputs = midiAccess.inputs;
        var outputs = midiAccess.outputs;
        // loop over all available inputs and listen for any MIDI input
        for (var input of midiAccess.inputs.values()) {
          // each time there is a midi message call the onMIDIMessage function
          input.onmidimessage = onMIDIMessage;
        }
      }

      function onMIDIFailure(error) {
        // when we get a failed response, run this code
        console.log("No access to MIDI devices or your browser doesn't support WebMIDI API. Please use WebMIDIAPIShim " + error);
      }

      /*
      function onMIDIMessage(midiMsg) {
        data = midiMsg.data; // this gives us our [command/channel, note, velocity] data.
        console.log('MIDI data', data); // MIDI data [144, 63, 73]
      }
      */
     
      const NOTE_ON = 0x90;
      const NOTE_OFF = 0x80;
      const CONTROL_CHANGE = 0xb0;
      const PROGRAM_CHANGE = 0xc0;
      const SYSTEM_EXCLUSIVE = 0xf0;
      
      function onMIDIMessage(midiMsg) {
        var status = midiMsg.data[0];
        var channel = midiMsg.data[0] & 0xF;

        switch (status) {
          case NOTE_ON:
            //noteOn(midiMsg.data[1], midiMsg.data[2]);
            console.log("NOTE_ON " + midiMsg.data[1] + "\tVAL " + midiMsg.data[2]);
            break;
          case NOTE_OFF:
            //noteOff(midiMsg.data[1], midiMsg.data[2]);
            console.log("NOTE_OFF " + midiMsg.data[1] + "\tVAL " + midiMsg.data[2]);
            break;
          case CONTROL_CHANGE:
            //var channel = midiMsg.data[0] & 0xF;
            //controlChange(midiMsg.data[1], midiMsg.data[2]);
            console.log("CHANNEL " + channel + "\tCONTROL_CHANGE " + midiMsg.data[1] + "\tVAL " + midiMsg.data[2]);
            break;
          case PROGRAM_CHANGE:
            console.log("PROGRAM_CHANGE " + midiMsg.data[1]);
            break;
          case SYSTEM_EXCLUSIVE:
            console.log("SYSTEM_EXCLUSIVE " + midiMsg.data[1]);
            break;
        }
      }

      function noteOn(channel, note, volume) {
        if (output === undefined) return
        console.log('noteOn')
        output.send([NOTE_ON + channel, note, volume])
      }

      function noteOff(channel, note, volume) {
        if (output === undefined) return
        console.log('noteOff');
        output.send([NOTE_OFF + channel, note, volume]);
      }

      function controlChange(value, channel) {
        if (output === undefined) return
        console.log('controlChange');
        output.send([CONTROL_CHANGE + channel, value]);
      }

      function programChange(idx, channel) {
        if (output === undefined) return
        console.log('programChange');
        output.send([PROGRAM_CHANGE + channel, idx]);
      }
      
      function sysex(output, data) {
        if (output === undefined) return
        console.log('sysex');
        output.send(data)
      }

      async function loadConfig(event) {
        configFile = event.target.files[0];
        console.log(configFile);
      }

      // When the send button is pressed
      function sendConfig() {
        // Send the midiMsg

        // And clear the input field, so it's clear it has been sent
        configFile.value = "";
      }
    </script>      
    <script src="./js/sketch.js"></script>
  
  </body>

</html>